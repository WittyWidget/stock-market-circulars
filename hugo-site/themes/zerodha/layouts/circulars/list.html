{{ define "title" }}{{ .Title }} - {{ .Site.Title }}{{ end }}

{{ define "description" }}{{ .Params.description | default .Summary | default "Browse circulars and regulatory documents" }}{{ end }}

{{ define "main" }}
<div>
    <!-- Page Header -->
    <div class="mb-8">
        <nav class="breadcrumbs text-sm mb-4">
            <ul>
                <li><a href="{{ .Site.BaseURL }}">Home</a></li>
                {{ if ne .RelPermalink "/circulars/" }}
                <li><a href="{{ "circulars" | relURL }}">All Circulars</a></li>
                {{ end }}
                <li>{{ .Title }}</li>
            </ul>
        </nav>
        
        <h1 class="text-4xl font-bold mb-4">{{ .Title }}</h1>
        {{ if .Content }}
        <div class="prose prose-lg mb-6">
            {{ .Content }}
        </div>
        {{ end }}
    </div>

    <!-- Stats -->
    <div class="stats shadow mb-8">
        <div class="stat">
            <div class="stat-title">{{ .Title }}</div>
            <div class="stat-value">
                {{ if or (eq .RelPermalink "/circulars/") (eq .RelPermalink "/stock-market-circulars/circulars/") }}
                    {{ $allCirculars := where .Site.RegularPages "Section" "circulars" }}
                    {{ $withSource := where $allCirculars "Params.source" "!=" nil }}
                    {{ len $withSource }}
                {{ else }}
                    {{ len .Pages }}
                {{ end }}
            </div>
            <div class="stat-desc">Total regulatory updates</div>
        </div>
        <div class="stat">
            <div class="stat-title">Categories</div>
            <div class="stat-value text-sm">
                {{ $categories := slice }}
                {{ $targetPages := .Pages }}
                {{ if or (eq .RelPermalink "/circulars/") (eq .RelPermalink "/stock-market-circulars/circulars/") }}
                    {{ $targetPages = where (where .Site.RegularPages "Section" "circulars") "Params.source" "!=" nil }}
                {{ end }}
                {{ range $targetPages }}
                    {{ if .Params.category }}
                        {{ $categories = $categories | append .Params.category }}
                    {{ end }}
                {{ end }}
                {{ len (uniq $categories) }}
            </div>
            <div class="stat-desc">Different categories covered</div>
        </div>
    </div>

    <!-- Source Filter (only show on main circulars page) -->
    {{ if eq .RelPermalink "/circulars/" }}
    <div class="mb-8">
        <h2 class="text-2xl font-bold mb-4">Browse by Source</h2>
        <div class="flex flex-wrap gap-4">
            <a href="{{ "circulars/nse" | relURL }}" class="btn btn-outline btn-lg hover:btn-primary">
                <span class="font-bold">NSE</span>
                <div class="badge badge-ghost ml-2">{{ len (where .Site.RegularPages "Params.source" "NSE") }}</div>
            </a>
            <a href="{{ "circulars/bse" | relURL }}" class="btn btn-outline btn-lg hover:btn-primary">
                <span class="font-bold">BSE</span>
                <div class="badge badge-ghost ml-2">{{ len (where .Site.RegularPages "Params.source" "BSE") }}</div>
            </a>
            <a href="{{ "circulars/sebi" | relURL }}" class="btn btn-outline btn-lg hover:btn-primary">
                <span class="font-bold">SEBI</span>
                <div class="badge badge-ghost ml-2">{{ len (where .Site.RegularPages "Params.source" "SEBI") }}</div>
            </a>
        </div>
    </div>
    {{ end }}

    <!-- Circulars Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {{ $pages := .Pages }}
        {{ if or (eq .RelPermalink "/circulars/") (eq .RelPermalink "/stock-market-circulars/circulars/") }}
            {{ $allCirculars := where .Site.RegularPages "Section" "circulars" }}
            {{ $pages = where $allCirculars "Params.source" "!=" nil }}
        {{ end }}
        {{ $paginator := .Paginate $pages 12 }}
        {{ range $paginator.Pages }}
        {{ if .Params.source }}
            {{ partial "circular-card.html" . }}
        {{ end }}
        {{ end }}
    </div>

    <!-- Pagination -->
    {{ if gt $paginator.TotalPages 1 }}
    <div class="flex flex-col items-center mt-12 gap-4">
        <!-- Pagination Info -->
        <div class="text-sm text-gray-600">
            Showing {{ add (mul (sub $paginator.PageNumber 1) $paginator.PagerSize) 1 }} - {{ if lt (mul $paginator.PageNumber $paginator.PagerSize) $paginator.TotalNumberOfElements }}{{ mul $paginator.PageNumber $paginator.PagerSize }}{{ else }}{{ $paginator.TotalNumberOfElements }}{{ end }} of {{ $paginator.TotalNumberOfElements }} circulars
        </div>
        
        <!-- Pagination Controls -->
        <div class="join shadow-lg">
            {{ if $paginator.HasPrev }}
            <a href="{{ $paginator.Prev.URL }}" class="join-item btn btn-outline hover:btn-primary">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Previous
            </a>
            {{ else }}
            <button class="join-item btn btn-outline btn-disabled">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Previous
            </button>
            {{ end }}
            
            <!-- Page Numbers -->
            {{ $currentPage := $paginator.PageNumber }}
            {{ $totalPages := $paginator.TotalPages }}
            {{ $startPage := 1 }}
            {{ $endPage := $totalPages }}
            
            {{ if gt $totalPages 7 }}
                {{ if le $currentPage 4 }}
                    {{ $startPage = 1 }}
                    {{ $endPage = 5 }}
                {{ else if ge $currentPage (sub $totalPages 3) }}
                    {{ $startPage = sub $totalPages 4 }}
                    {{ $endPage = $totalPages }}
                {{ else }}
                    {{ $startPage = sub $currentPage 2 }}
                    {{ $endPage = add $currentPage 2 }}
                {{ end }}
            {{ end }}
            
            {{ if gt $startPage 1 }}
            <a href="{{ (index $paginator.Pagers 0).URL }}" class="join-item btn btn-outline hover:btn-primary">1</a>
            {{ if gt $startPage 2 }}
            <button class="join-item btn btn-outline btn-disabled">...</button>
            {{ end }}
            {{ end }}
            
            {{ range $paginator.Pagers }}
                {{ if and (ge .PageNumber $startPage) (le .PageNumber $endPage) }}
                    {{ if eq . $paginator }}
                    <button class="join-item btn btn-primary">{{ .PageNumber }}</button>
                    {{ else }}
                    <a href="{{ .URL }}" class="join-item btn btn-outline hover:btn-primary">{{ .PageNumber }}</a>
                    {{ end }}
                {{ end }}
            {{ end }}
            
            {{ if lt $endPage $totalPages }}
            {{ if lt $endPage (sub $totalPages 1) }}
            <button class="join-item btn btn-outline btn-disabled">...</button>
            {{ end }}
            <a href="{{ (index $paginator.Pagers (sub $totalPages 1)).URL }}" class="join-item btn btn-outline hover:btn-primary">{{ $totalPages }}</a>
            {{ end }}
            
            {{ if $paginator.HasNext }}
            <a href="{{ $paginator.Next.URL }}" class="join-item btn btn-outline hover:btn-primary">
                Next
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </a>
            {{ else }}
            <button class="join-item btn btn-outline btn-disabled">
                Next
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </button>
            {{ end }}
        </div>
    </div>
    {{ end }}

    <!-- Popular Tags (only show on source-specific pages) -->
    {{ if and (ne .RelPermalink "/circulars/") (.Pages) }}
    {{ $allTags := slice }}
    {{ range .Pages }}
        {{ range .Params.tags }}
            {{ $allTags = $allTags | append . }}
        {{ end }}
    {{ end }}
    {{ $topTags := first 15 (sort (uniq $allTags)) }}
    {{ if $topTags }}
    <div class="mt-12">
        <h2 class="text-2xl font-bold mb-4">Popular Tags for {{ .Title }}</h2>
        <div class="flex flex-wrap gap-2">
            {{ range $topTags }}
            <a href="{{ printf "/tags/%s/" (urlize .) | relURL }}" 
               class="btn btn-outline btn-sm hover:btn-primary">
                {{ . }}
            </a>
            {{ end }}
        </div>
    </div>
    {{ end }}
    {{ end }}
</div>
{{ end }}