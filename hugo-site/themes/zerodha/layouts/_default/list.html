{{ define "title" }}{{ .Title }} - {{ .Site.Title }}{{ end }}

{{ define "description" }}{{ .Params.description | default .Summary | default "Browse circulars and regulatory documents" }}{{ end }}

{{ define "main" }}
<div>
    {{ if .Data.Singular }}
    <!-- Individual Taxonomy Term Page (e.g., individual tag page) -->
    <!-- Page Header -->
    <div class="page-header">
        <nav class="breadcrumbs">
            <ul>
                <li><a href="{{ .Site.BaseURL }}">Home</a></li>
                <li><a href="{{ printf "/%s/" .Data.Plural | relURL }}">{{ .Data.Plural | title }}</a></li>
                <li>{{ .Title }}</li>
            </ul>
        </nav>
        
        <h1 class="page-title">
            <span class="tag-hash-badge">#</span>{{ .Title }}
        </h1>
        <p class="page-description">{{ len .Pages }} circular{{ if ne (len .Pages) 1 }}s{{ end }} tagged with "{{ .Title }}"</p>
    </div>

    <!-- Stats -->
    <div class="statistics-container">
        <div class="statistic-card">
            <div class="statistic-title">Tagged Circulars</div>
            <div class="statistic-value">{{ len .Pages }}</div>
            <div class="statistic-description">Total circulars with this tag</div>
        </div>
        <div class="statistic-card">
            <div class="statistic-title">Sources</div>
            <div class="statistic-value">
                {{ $sources := slice }}
                {{ range .Pages }}
                    {{ if .Params.source }}
                        {{ $sources = $sources | append .Params.source }}
                    {{ end }}
                {{ end }}
                {{ len (uniq $sources) }}
            </div>
            <div class="statistic-description">Different regulatory sources</div>
        </div>
    </div>

    <!-- Circulars Grid -->
    <div class="circulars-grid">
        {{ $paginator := .Paginate .Pages 12 }}
        {{ range $paginator.Pages }}
        {{ if .Params.source }}
            {{ partial "circular-card.html" . }}
        {{ end }}
        {{ end }}
    </div>

    <!-- Pagination -->
    {{ with $paginator }}
    {{ partial "pagination.html" . | safeHTML }}
    {{ end }}

    <!-- Related Tags -->
    {{ if .Pages }}
    {{ $allTags := slice }}
    {{ range .Pages }}
        {{ range .Params.tags }}
            {{ if ne . $.Title }}
                {{ $allTags = $allTags | append . }}
            {{ end }}
        {{ end }}
    {{ end }}
    {{ $relatedTags := first 10 (sort (uniq $allTags)) }}
    {{ if $relatedTags }}
    <div class="popular-tags-section">
        <h2 class="popular-tags-title">Related Tags</h2>
        <div class="popular-tags-grid">
            {{ range $relatedTags }}
            <a href="{{ printf "/tags/%s/" (urlize .) | relURL }}" 
               class="stock-tag">
                {{ . | lower }}
            </a>
            {{ end }}
        </div>
    </div>
    {{ end }}
    {{ end }}

    {{ else }}
    <!-- Regular List Page -->
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">{{ .Title }}</h1>
        {{ if .Content }}
        <div class="page-description">
            {{ .Content }}
        </div>
        {{ end }}
    </div>

    <!-- Stats -->
    <div class="statistics-container">
        <div class="statistic-card">
            <div class="statistic-title">Total Circulars</div>
            <div class="statistic-value">{{ len (where .Site.RegularPages "Section" "circulars") }}</div>
            <div class="statistic-description">Latest regulatory updates</div>
        </div>
    </div>

    <!-- Circulars Grid -->
    <div class="circulars-grid">
        {{ $pages := .Pages }}
        {{ if eq .Section "circulars" }}
            {{ $pages = where .Site.RegularPages "Section" "circulars" }}
        {{ end }}
        {{ range $pages }}
        {{ if .Params.source }}
            {{ partial "circular-card.html" . }}
        {{ end }}
        {{ end }}
    </div>
    {{ end }}
</div>

{{ end }}